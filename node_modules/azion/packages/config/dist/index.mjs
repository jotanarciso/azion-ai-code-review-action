import I from"ajv";import $ from"ajv-errors";import H from"ajv-keywords";function z(e){let s={...e},r=["httpToHttps","bypassCache","forwardCookies","capture","setOrigin","rewrite","setCookie","setHeaders","runFunction","setCache","redirectTo301","redirectTo302","deliver"],t=["enableGZIP","capture","setCookie","setHeaders","filterHeader","filterCookie","runFunction","redirectTo301","redirectTo302","deliver"],i=(o,a)=>o.map(n=>{let c={...n,behavior:{...n.behavior}};return Object.keys(n).forEach(d=>{a.includes(d)&&(c.behavior[d]=n[d],delete c[d])}),c});return s.rules&&s.rules.request&&(s.rules.request=i(s.rules.request,r)),s.rules&&s.rules.response&&(s.rules.response=i(s.rules.response,t)),s}var T=z;var O={type:"object",properties:{build:{type:"object",properties:{entry:{type:"string",errorMessage:"The 'entry' field must be a string representing the entry point file path."},builder:{type:["string","null"],enum:["esbuild","webpack",null],errorMessage:"The 'builder' field must be either 'esbuild', 'webpack', or null."},polyfills:{type:"boolean",errorMessage:"The 'polyfills' field must be a boolean."},worker:{type:"boolean",errorMessage:"The 'worker' field must be a boolean."},preset:{type:"object",properties:{name:{type:"string",errorMessage:"The 'preset.name' field must be a string."}},required:["name"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'preset' object.",required:"The 'name' and 'mode' fields are required in the 'preset' object."}},memoryFS:{type:"object",properties:{injectionDirs:{type:["array","null"],items:{type:"string"},errorMessage:"The 'memoryFS.injectionDirs' field must be an array of strings or null."},removePathPrefix:{type:["string","null"],errorMessage:"The 'memoryFS.removePathPrefix' field must be a string or null."}},additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'memoryFS' object."}},custom:{type:"object",additionalProperties:!0,errorMessage:"The 'custom' field must be an object."}},additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'build' object."}},origin:{type:"array",items:{type:"object",properties:{id:{type:"integer",errorMessage:"The 'id' field must be a number."},key:{type:"string",errorMessage:"The 'key' field must be a string."},name:{type:"string",errorMessage:"The 'name' field must be a string."},type:{type:"string",enum:["single_origin","object_storage","load_balancer","live_ingest"],errorMessage:"The 'type' field must be a string and one of 'single_origin', 'object_storage', 'load_balancer' or 'live_ingest'."},bucket:{type:["string","null"],errorMessage:"The 'bucket' field must be a string or null."},prefix:{type:["string","null"],errorMessage:"The 'prefix' field must be a string or null."},addresses:{anyOf:[{type:"array",items:{type:"string"},errorMessage:{type:"The 'addresses' field must be an array of strings."}},{type:"array",items:{type:"object",properties:{address:{type:"string",errorMessage:"The 'address' field must be a string."},weight:{type:"integer"}},required:["address"],additionalProperties:!1,errorMessage:{type:"The 'addresses' field must be an array of objects.",additionalProperties:"No additional properties are allowed in address items.",required:"The 'address' field is required in each address item."}}}]},hostHeader:{type:"string",errorMessage:"The 'hostHeader' field must be a string."},protocolPolicy:{type:"string",enum:["preserve","http","https"],errorMessage:"The 'protocolPolicy' field must be either 'http', 'https' or 'preserve'. Default is 'preserve'."},redirection:{type:"boolean",errorMessage:"The 'redirection' field must be a boolean."},method:{type:"string",enum:["ip_hash","least_connections","round_robin"],errorMessage:"The 'method' field must be either 'ip_hash', 'least_connections' or 'round_robin'. Default is 'ip_hash'."},path:{type:"string",errorMessage:"The 'path' field must be a string."},connectionTimeout:{type:"integer",errorMessage:"The 'connectionTimeout' field must be a number. Default is 60."},timeoutBetweenBytes:{type:"integer",errorMessage:"The 'timeoutBetweenBytes' field must be a number. Default is 120."},hmac:{type:"object",properties:{region:{type:"string",errorMessage:"The 'region' field must be a string."},accessKey:{type:"string",errorMessage:"The 'accessKey' field must be a string."},secretKey:{type:"string",errorMessage:"The 'secretKey' field must be a string."}},required:["region","accessKey","secretKey"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the hmac object.",required:"The 'region, accessKey and secretKey' fields are required in the hmac object."}}},required:["name","type"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in origin item objects.",required:"The 'name and type' field is required in each origin item."}},errorMessage:{additionalProperties:"The 'origin' field must be an array of objects."}},cache:{type:"array",items:{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},stale:{type:"boolean",errorMessage:"The 'stale' field must be a boolean."},queryStringSort:{type:"boolean",errorMessage:"The 'queryStringSort' field must be a boolean."},methods:{type:"object",properties:{post:{type:"boolean",errorMessage:"The 'post' field must be a boolean."},options:{type:"boolean",errorMessage:"The 'options' field must be a boolean."}},additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'methods' object."}},browser:{type:"object",properties:{maxAgeSeconds:{oneOf:[{type:"number",errorMessage:"The 'maxAgeSeconds' field must be a number or a valid mathematical expression."},{type:"string",pattern:"^[0-9+*/.() -]+$",errorMessage:"The 'maxAgeSeconds' field must be a valid mathematical expression."}]}},required:["maxAgeSeconds"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'browser' object.",required:"The 'maxAgeSeconds' field is required in the 'browser' object."}},edge:{type:"object",properties:{maxAgeSeconds:{oneOf:[{type:"number",errorMessage:"The 'maxAgeSeconds' field must be a number or a valid mathematical expression."},{type:"string",pattern:"^[0-9+*/.() -]+$",errorMessage:"The 'maxAgeSeconds' field must be a valid mathematical expression."}]}},required:["maxAgeSeconds"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'edge' object.",required:"The 'maxAgeSeconds' field is required in the 'edge' object."}},cacheByCookie:{type:"object",properties:{option:{type:"string",enum:["ignore","varies","whitelist","blacklist"],errorMessage:"The 'option' field must be one of 'ignore', 'varies', 'whitelist' or 'blacklist'.."},list:{type:"array",items:{type:"string",errorMessage:"Each item in 'list' must be a string."},errorMessage:{type:"The 'list' field must be an array of strings."}}},required:["option"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'cacheByCookie' object.",required:"The 'option' field is required in the 'cacheByCookie' object."},if:{properties:{option:{enum:["whitelist","blacklist"]}}},then:{required:["list"],errorMessage:{required:"The 'list' field is required when 'option' is 'whitelist' or 'blacklist'."}}},cacheByQueryString:{type:"object",properties:{option:{type:"string",enum:["ignore","varies","whitelist","blacklist"],errorMessage:"The 'option' field must be one of 'ignore', 'varies', 'whitelist' or 'blacklist'."},list:{type:"array",items:{type:"string",errorMessage:"Each item in 'list' must be a string."},errorMessage:{type:"The 'list' field must be an array of strings."}}},required:["option"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'cacheByQueryString' object.",required:"The 'option' field is required in the 'cacheByQueryString' object."},if:{properties:{option:{enum:["whitelist","blacklist"]}}},then:{required:["list"],errorMessage:{required:"The 'list' field is required when 'option' is 'whitelist' or 'blacklist'."}}}},required:["name"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in cache item objects.",required:"The 'name' field is required in each cache item."}},errorMessage:{additionalProperties:"The 'cache' field must be an array of objects."}},rules:{type:"object",properties:{request:{type:"array",items:{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},description:{type:"string",errorMessage:"The 'description' field must be a string."},active:{type:"boolean",default:!0,errorMessage:"The 'active' field must be a boolean."},match:{type:"string",errorMessage:"The 'match' field must be a string."},variable:{type:"string",errorMessage:"The 'variable' field must be a string."},behavior:{type:"object",properties:{setOrigin:{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},type:{type:"string",errorMessage:"The 'type' field must be a string."}},required:["name","type"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'setOrigin' object.",required:"The 'name or type' field is required in the 'setOrigin' object."}},rewrite:{type:"string",errorMessage:"The 'rewrite' field must be a string."},setHeaders:{type:"array",items:{type:"string",errorMessage:"Each item in 'setHeaders' must be a string."},errorMessage:{type:"The 'setHeaders' field must be an array of strings."}},bypassCache:{type:["boolean","null"],errorMessage:"The 'bypassCache' field must be a boolean or null."},httpToHttps:{type:["boolean","null"],errorMessage:"The 'httpToHttps' field must be a boolean or null."},redirectTo301:{type:["string","null"],errorMessage:"The 'redirectTo301' field must be a string or null."},redirectTo302:{type:["string","null"],errorMessage:"The 'redirectTo302' field must be a string or null."},forwardCookies:{type:["boolean","null"],errorMessage:"The 'forwardCookies' field must be a boolean or null."},setCookie:{type:["string","null"],errorMessage:"The 'setCookie' field must be a string or null."},deliver:{type:["boolean","null"],errorMessage:"The 'deliver' field must be a boolean or null."},capture:{type:"object",properties:{match:{type:"string",errorMessage:"The 'match' field must be a string."},captured:{type:"string",errorMessage:"The 'captured' field must be a string."},subject:{type:"string",errorMessage:"The 'subject' field must be a string."}},required:["match","captured","subject"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'capture' object.",required:"All properties ('match', 'captured', 'subject') are required in the 'capture' object."}},runFunction:{type:"object",properties:{path:{type:"string",errorMessage:"The 'path' field must be a string."},name:{type:["string","null"],errorMessage:"The 'name' field can be a string or null."}},required:["path"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'runFunction' object.",required:"The 'path' field is required in the 'runFunction' object."}},setCache:{oneOf:[{type:"string",errorMessage:"The 'setCache' field must be a string."},{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},browser_cache_settings_maximum_ttl:{type:"number",nullable:!0,errorMessage:"The 'browser_cache_settings_maximum_ttl' field must be a number or null."},cdn_cache_settings_maximum_ttl:{type:"number",nullable:!0,errorMessage:"The 'cdn_cache_settings_maximum_ttl' field must be a number or null."}},required:["name"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the cache object.",required:"The 'name' field is required in the cache object."}}],errorMessage:"The 'cache' field must be either a string or an object with specified properties."}},additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'behavior' object."}}},required:["name","match"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in request items.",required:"The 'name' and 'match' fields are required in each request item."}}},response:{type:"array",items:{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},description:{type:"string",errorMessage:"The 'description' field must be a string."},active:{type:"boolean",default:!0,errorMessage:"The 'active' field must be a boolean."},match:{type:"string",errorMessage:"The 'match' field must be a string."},variable:{type:"string",errorMessage:"The 'variable' field must be a string."},behavior:{type:"object",properties:{setCookie:{type:["string","null"],errorMessage:"The 'setCookie' field must be a string or null."},setHeaders:{type:"array",items:{type:"string",errorMessage:"Each item in 'setHeaders' must be a string."},errorMessage:{type:"The 'setHeaders' field must be an array of strings."}},deliver:{type:["boolean","null"],errorMessage:"The 'deliver' field must be a boolean or null."},capture:{type:"object",properties:{match:{type:"string",errorMessage:"The 'match' field must be a string."},captured:{type:"string",errorMessage:"The 'captured' field must be a string."},subject:{type:"string",errorMessage:"The 'subject' field must be a string."}},required:["match","captured","subject"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'capture' object.",required:"All properties ('match', 'captured', 'subject') are required in the 'capture' object."}},enableGZIP:{type:["boolean","null"],errorMessage:"The 'enableGZIP' field must be a boolean or null."},filterCookie:{type:["string","null"],errorMessage:"The 'filterCookie' field must be a string or null."},filterHeader:{type:["string","null"],errorMessage:"The 'filterHeader' field must be a string or null."},runFunction:{type:"object",properties:{path:{type:"string",errorMessage:"The 'path' field must be a string."},name:{type:["string","null"],errorMessage:"The 'name' field can be a string or null."}},required:["path"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'runFunction' object.",required:"The 'path' field is required in the 'runFunction' object."}},redirectTo301:{type:["string","null"],errorMessage:"The 'redirectTo301' field must be a string or null."},redirectTo302:{type:["string","null"],errorMessage:"The 'redirectTo302' field must be a string or null."}},additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'behavior' object."}}},required:["name","match"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in response items.",required:"The 'name' and 'match' fields are required in each response item."}}}},anyOf:[{required:["request"]},{required:["response"]}],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the 'rules' object.",anyOf:"Either 'request' or 'response' must be provided."}},networkList:{type:"array",items:{type:"object",properties:{id:{type:"number",errorMessage:"The 'id' field must be a number."},listType:{type:"string",errorMessage:"The 'listType' field must be a string."},listContent:{type:"array",items:{type:"string",errorMessage:"The 'listContent' field must be an array of strings."}}},required:["id","listType","listContent"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in network list items.",required:"The 'id, listType and listContent' fields are required in each network list item."}}},domain:{type:"object",properties:{name:{type:"string",errorMessage:"The 'name' field must be a string."},cnameAccessOnly:{type:"boolean",errorMessage:"The 'cnameAccessOnly' field must be a boolean."},cnames:{type:"array",items:{type:"string",errorMessage:"Each item in 'cnames' must be a string."},errorMessage:{type:"The 'cnames' field must be an array of strings."}},edgeApplicationId:{type:"number",errorMessage:"The 'edgeApplicationId' field must be a number."},edgeFirewallId:{type:"number",errorMessage:"The 'edgeFirewallId' field must be a number."},digitalCertificateId:{type:["string","number","null"],errorMessage:"The 'digitalCertificateId' field must be a string, number or null. If string, it must be 'lets_encrypt'."},mtls:{type:"object",properties:{verification:{type:"string",enum:["enforce","permissive"],errorMessage:"The 'verification' field must be a string."},trustedCaCertificateId:{type:"number",errorMessage:"The 'trustedCaCertificateId' field must be a number."},crlList:{type:"array",items:{type:"number",errorMessage:"Each item in 'crlList' must be a number."},errorMessage:{type:"The 'crlList' field must be an array of numbers."}}},required:["verification","trustedCaCertificateId"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the mtls object.",required:"The 'verification and trustedCaCertificateId' fields are required in the mtls object."}}},required:["name"],additionalProperties:!1,errorMessage:{type:"The 'domain' field must be an object.",additionalProperties:"No additional properties are allowed in the domain object.",required:"The 'name' field is required in the domain object."}},purge:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["url","cachekey","wildcard"],errorMessage:"The 'type' field must be either 'url', 'cachekey' or 'wildcard'."},urls:{type:"array",items:{type:"string",errorMessage:"Each item in 'urls' must be a string."},errorMessage:{type:"The 'urls' field must be an array of strings."}},method:{type:"string",enum:["delete"],errorMessage:"The 'method' field must be either 'delete'. Default is 'delete'."},layer:{type:"string",enum:["edge_caching","l2_caching"],errorMessage:"The 'layer' field must be either 'edge_caching' or 'l2_caching'. Default is 'edge_caching'."}},required:["type","urls"],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in purge items.",required:"The 'type and urls' fields are required in each purge item."}}}},required:[],additionalProperties:!1,errorMessage:{additionalProperties:"No additional properties are allowed in the configuration object.",required:"The 'rules' section is required in the configuration object."}},w=O;var p=class{transformToManifest(s,r){return r}transformToConfig(s,r){return s}},l=p;var u=class extends l{transformToManifest(s){let r=s?.build;return r||{}}transformToConfig(s,r){let t=s?.build;return r.build=t,r.build}},M=u;import{evaluate as N}from"mathjs";var m=class extends l{evaluateMathExpression=s=>{if(typeof s=="number")return s;if(/^[0-9+\-*/.() ]+$/.test(s))return N(s);throw new Error(`Expression is not purely mathematical: ${s}`)};transformToManifest(s){let r=[];return!Array.isArray(s?.cache)||s?.cache.length===0||s?.cache.forEach(t=>{let i=t?.browser?this.evaluateMathExpression(t.browser.maxAgeSeconds):0,o=t?.edge?this.evaluateMathExpression(t.edge.maxAgeSeconds):60,a={name:t.name,browser_cache_settings:t?.browser?"override":"honor",browser_cache_settings_maximum_ttl:i,cdn_cache_settings:t?.edge?"override":"honor",cdn_cache_settings_maximum_ttl:o,enable_caching_for_post:t?.methods?.post||!1,enable_caching_for_options:t?.methods?.options||!1,enable_query_string_sort:t?.queryStringSort||!1};t.cacheByQueryString&&(a.cache_by_query_string=t.cacheByQueryString.option==="varies"?"all":t.cacheByQueryString.option,t.cacheByQueryString.option==="whitelist"||t.cacheByQueryString.option==="blacklist"?a.query_string_fields=t.cacheByQueryString.list||[]:a.query_string_fields=[]),t.cacheByCookie&&(a.cache_by_cookie=t.cacheByCookie.option==="varies"?"all":t.cacheByCookie.option,t.cacheByCookie.option==="whitelist"||t.cacheByCookie.option==="blacklist"?a.cookie_names=t.cacheByCookie.list||[]:a.cookie_names=[]),r.push(a)}),r}transformToConfig(s,r){let t=s.cache;if(!(!Array.isArray(t)||t.length===0))return r.cache=[],t.forEach(i=>{let o=i.browser_cache_settings_maximum_ttl?this.evaluateMathExpression(i.browser_cache_settings_maximum_ttl):0,a=i.cdn_cache_settings_maximum_ttl?this.evaluateMathExpression(i.cdn_cache_settings_maximum_ttl):60,n={name:i.name,stale:i.stale,browser:{maxAgeSeconds:o},edge:{maxAgeSeconds:a},methods:{post:i.enable_caching_for_post,options:i.enable_caching_for_options},queryStringSort:i.enable_query_string_sort};i.cache_by_query_string&&(n.cacheByQueryString={option:i.cache_by_query_string==="varies"?"all":i.cache_by_query_string},i.cache_by_query_string==="whitelist"||i.cache_by_query_string==="blacklist"?n.cacheByQueryString={...n.cacheByQueryString,list:i.query_string_fields||[]}:n.cacheByQueryString={...n.cacheByQueryString,list:[]}),i.cache_by_cookie&&(n.cacheByCookie={option:i.cache_by_cookie==="varies"?"all":i.cache_by_cookie},i.cache_by_cookie==="whitelist"||i.cache_by_cookie==="blacklist"?n.cacheByCookie={...n.cacheByCookie,list:i.cookie_names||[]}:n.cacheByCookie={...n.cacheByCookie,list:[]}),r.cache.push(n)}),r.cache}},C=m;var g=class extends l{transformToManifest(s){let r=s?.domain;if(!r)return{};if(r.digitalCertificateId&&typeof r.digitalCertificateId=="string"&&r.digitalCertificateId!=="lets_encrypt")throw new Error(`Domain ${r.name} has an invalid digital certificate ID: ${r.digitalCertificateId}. Only 'lets_encrypt' or null is supported.`);if(r.mtls?.verification&&r.mtls.verification!=="enforce"&&r.mtls.verification!=="permissive")throw new Error(`Domain ${r.name} has an invalid verification value: ${r.mtls.verification}. Only 'enforce' or 'permissive' is supported.`);let t={name:r.name,cname_access_only:r.cnameAccessOnly||!1,cnames:r.cnames||[],digital_certificate_id:r.digitalCertificateId||null,edge_application_id:r.edgeApplicationId||null,edge_firewall_id:r.edgeFirewallId||null,active:!0};return r.mtls?(t.is_mtls_enabled=!0,t.mtls_verification=r.mtls.verification,t.mtls_trusted_ca_certificate_id=r.mtls.trustedCaCertificateId,t.crl_list=r.mtls.crlList||[]):t.is_mtls_enabled=!1,t}transformToConfig(s,r){let t=s.domain||{};return r.domain={name:t.name,cnameAccessOnly:t.cname_access_only,cnames:t.cnames,digitalCertificateId:t.digital_certificate_id,edgeApplicationId:t.edge_application_id,edgeFirewallId:t.edge_firewall_id,mtls:{verification:t.mtls_verification,trustedCaCertificateId:t.mtls_trusted_ca_certificate_id,crlList:t.crl_list}},r.domain}},v=g;var f=class extends l{transformToManifest(s){let r=[];if(!Array.isArray(s?.origin)||s?.origin.length===0)return r;let t=["single_origin","object_storage","load_balancer","live_ingest"];return s?.origin.forEach(i=>{if(t.indexOf(i.type)===-1)throw new Error(`Rule setOrigin originType '${i.type}' is not supported`);let o={id:i.id,key:i.key,name:i.name,origin_type:i.type};if(i.type!=="object_storage"){if(i.path==="/")throw new Error('Origin path cannot be "/". Please use empty string or "/path"');if(o.origin_path=i.path||"",o.origin_protocol_policy=i.protocolPolicy||"preserve",o.method=i.method||"ip_hash",o.is_origin_redirection_enabled=i.redirection||!1,o.connection_timeout=i.connectionTimeout||60,o.timeout_between_bytes=i.timeoutBetweenBytes||120,i.addresses&&i.addresses.length>0){let a=[];i?.addresses.forEach(n=>{if(typeof n=="string"){a.push({address:n});return}if(n?.weight<0||n?.weight>10)throw new Error(`When origin type is ${i.type}, weight must be between 0 and 10`);a.push(n)}),o.addresses=a}else throw new Error(`When origin type is ${i.type}, addresses is required`);o.host_header=i.hostHeader||"${host}",i?.hmac&&(o.hmac_authentication=!0,o.hmac_region_name=i.hmac?.region,o.hmac_access_key=i.hmac?.accessKey,o.hmac_secret_key=i.hmac?.secretKey)}else i.type==="object_storage"&&(o.bucket=i.bucket,o.prefix=i.prefix||"");r.push(o)}),r}transformToConfig(s,r){let t=s.origin;if(!Array.isArray(t)||t.length===0)return;r.origin=[];let i=["single_origin","object_storage","load_balancer","live_ingest"];return t.forEach(o=>{if(i.indexOf(o.origin_type)===-1)throw new Error(`originType '${o.origin_type}' is not supported`);let a={id:o.id,key:o.key,name:o.name,type:o.origin_type};if(a.type!=="object_storage"){if(o.path==="/")throw new Error('Origin path cannot be "/". Please use empty string or "/path"');a.path=o.origin_path,a.protocolPolicy=o.origin_protocol_policy,a.method=o.method,a.redirection=o.is_origin_redirection_enabled,a.connectionTimeout=o.connection_timeout,a.timeoutBetweenBytes=o.timeout_between_bytes,a.addresses=o.addresses,a.hostHeader=o.host_header,o.hmac_authentication&&(a.hmac={region:o.hmac_region_name,accessKey:o.hmac_access_key,secretKey:o.hmac_secret_key})}else a.type==="object_storage"&&(a.bucket=o.bucket,a.prefix=o.prefix);r.origin.push(a)}),r.origin}},q=f;var h=class extends l{transformToManifest(s){let r=[];return!Array.isArray(s?.purge)||s?.purge.length===0||s?.purge.forEach(t=>{t?.urls.forEach(o=>{if(!o.includes("http://")&&!o.includes("https://"))throw new Error("The URL must contain the protocol (http:// or https://).");if(t?.type==="wildcard"&&!o.includes("*"))throw new Error("The URL must not contain the wildcard character (*).")});let i={type:t.type,urls:t.urls||[],method:t.method||"delete"};t?.type==="cachekey"&&(i.layer=t.layer||"edge_caching"),r.push(i)}),r}transformToConfig(s,r){let t=s.purge;if(!(!Array.isArray(t)||t.length===0))return r.purge=[],t.forEach(i=>{i.urls.forEach(a=>{if(!a.includes("http://")&&!a.includes("https://"))throw new Error("The URL must contain the protocol (http:// or https://).");if(i?.type==="wildcard"&&!a.includes("*"))throw new Error("The URL must not contain the wildcard character (*).")});let o={type:i.type,urls:i.urls||[],method:i.method||"delete"};i?.type==="cachekey"&&(o.layer=i.layer||"edge_caching"),r.purge.push(o)}),r.purge}},j=h;var k={setOrigin:{transform:(e,s)=>{let r=s.origin.find(t=>t.name===e.name&&t.origin_type===e.type);if(r){if(r.origin_type!==e.type)throw new Error(`Rule setOrigin originType '${e.type}' does not match the origin settings`)}else throw new Error(`Rule setOrigin name '${e.name}' not found in the origin settings`);return{name:"set_origin",target:r.name}}},rewrite:{transform:e=>{let s=[];return s.push({name:"rewrite_request",target:e}),s}},deliver:{transform:()=>({name:"deliver",target:null})},setCookie:{transform:e=>({name:"add_request_cookie",target:e})},setHeaders:{transform:e=>e.map(s=>({name:"add_request_header",target:s}))},setCache:{transform:(e,s)=>{if(typeof e=="string")return{name:"set_cache_policy",target:e};if(typeof e=="object"){let r={name:e.name,...e};return s.cache.push(r),{name:"set_cache_policy",target:e.name}}}},forwardCookies:{transform:e=>{if(e)return{name:"forward_cookies",target:null}}},runFunction:{transform:e=>({name:"run_function",target:e.path})},enableGZIP:{transform:e=>{if(e)return{name:"enable_gzip",target:""}}},bypassCache:{transform:e=>{if(e)return{name:"bypass_cache_phase",target:null}}},httpToHttps:{transform:e=>{if(e)return{name:"redirect_http_to_https",target:null}}},redirectTo301:{transform:e=>({name:"redirect_to_301",target:e})},redirectTo302:{transform:e=>({name:"redirect_to_302",target:e})},capture:{transform:e=>({name:"capture_match_groups",target:{regex:e.match,captured_array:e.captured,subject:`\${${e.subject??"uri"}}`}})}},A={setCookie:{transform:e=>({name:"set_cookie",target:e})},setHeaders:{transform:e=>e.map(s=>({name:"add_response_header",target:s}))},enableGZIP:{transform:e=>{if(e)return{name:"enable_gzip",target:""}}},filterCookie:{transform:e=>({name:"filter_response_cookie",target:e})},filterHeader:{transform:e=>({name:"filter_response_header",target:e})},runFunction:{transform:e=>({name:"run_function",target:e.path})},redirectTo301:{transform:e=>({name:"redirect_to_301",target:e})},redirectTo302:{transform:e=>({name:"redirect_to_302",target:e})},capture:{transform:e=>({name:"capture_match_groups",target:{regex:e.match,captured_array:e.captured,subject:`\${${e.subject??"uri"}}`}})}},P={set_origin:{transform:(e,s)=>{let r=s.origin.find(t=>t.name===e);if(!r)throw new Error(`Rule setOrigin name '${e.name}' not found in the origin settings`);return{setOrigin:{name:e,type:r.type}}}},rewrite_request:{transform:e=>({rewrite:e})},deliver:{transform:()=>({deliver:!0})},add_request_cookie:{transform:e=>({setCookie:e})},add_request_header:{transform:e=>({setHeaders:e.split(",")})},set_cache_policy:{transform:e=>{if(typeof e=="string")return{setCache:e};if(typeof e=="object")return{setCache:{name:e.name,...e}}}},forward_cookies:{transform:()=>({forwardCookies:!0})},run_function:{transform:e=>({runFunction:{path:e}})},enable_gzip:{transform:()=>({enableGZIP:!0})},bypass_cache_phase:{transform:()=>({bypassCache:!0})},redirect_http_to_https:{transform:()=>({httpToHttps:!0})},redirect_to_301:{transform:e=>({redirectTo301:e})},redirect_to_302:{transform:e=>({redirectTo302:e})},capture_match_groups:{transform:e=>({capture:{match:e.regex,captured:e.captured_array,subject:e.subject}})}},S={set_cookie:{transform:e=>({setCookie:e})},add_response_header:{transform:e=>({setHeaders:e.split(",")})},enable_gzip:{transform:()=>({enableGZIP:!0})},filter_response_cookie:{transform:e=>({filterCookie:e})},filter_response_header:{transform:e=>({filterHeader:e})},run_function:{transform:e=>({runFunction:{path:e}})},redirect_to_301:{transform:e=>({redirectTo301:e})},redirect_to_302:{transform:e=>({redirectTo302:e})}};var y=class extends l{addBehaviors(s,r,t,i){r&&typeof r=="object"&&Object.entries(r).forEach(([o,a])=>{if(t[o]){let n=t[o].transform(a,i);Array.isArray(n)?s.behaviors.push(...n):n&&s.behaviors.push(n)}else console.warn(`Unknown behavior: ${o}`)})}transformToManifest(s,r){let t=[];return Array.isArray(s?.rules?.request)&&s?.rules?.request?.forEach((i,o)=>{let a={name:i.name,phase:"request",description:i.description??"",is_active:i.active!==void 0?i.active:!0,order:o+2,criteria:[[{variable:`\${${i.variable??"uri"}}`,operator:"matches",conditional:"if",input_value:i.match}]],behaviors:[]};this.addBehaviors(a,i.behavior,k,r),t.push(a)}),Array.isArray(s?.rules?.response)&&s?.rules?.response.forEach((i,o)=>{let a={name:i.name,phase:"response",description:i.description??"",is_active:i.active!==void 0?i.active:!0,order:o+2,criteria:[[{variable:`\${${i.variable??"uri"}}`,operator:"matches",conditional:"if",input_value:i.match}]],behaviors:[]};this.addBehaviors(a,i.behavior,A,r),t.push(a)}),t}transformToConfig(s,r){let t=(o,a,n)=>{if(o&&Array.isArray(o))return o.map(c=>{let d=c.name;return a[d]?a[d].transform(c.target,n):(console.warn(`Unknown behavior: ${d}`),{})})[0]},i=s.rules;if(i)return r.rules={request:[],response:[]},i.forEach(o=>{o.phase==="request"?r.rules.request.push({name:o.name,description:o.description,active:o.is_active,variable:o.criteria[0].variable.replace("${","").replace("}",""),match:o.criteria[0].input_value,behavior:t(o.behaviors,P,r)}):o.phase==="response"&&r.rules.response.push({name:o.name,description:o.description,active:o.is_active,variable:o.criteria[0].variable.replace("${","").replace("}",""),match:o.criteria[0].input_value,behavior:t(o.behaviors,S,r)})}),r.rules}},x=y;var b=class{strategies;constructor(){this.strategies={}}setStrategy(s,r){this.strategies[s]=r}transformToManifest(s,r){return Object.keys(this.strategies).forEach(t=>{r[t]=this.strategies[t].transformToManifest(s,r)}),r}transformToConfig(s,r){return Object.keys(this.strategies).forEach(t=>{r[t]=this.strategies[t].transformToConfig(s,r)}),r}},B=b;function _(e){let s=new I({allErrors:!0,$data:!0,allowUnionTypes:!0});$(s),H(s,["instanceof"]);let r=s.compile(w);if(!r(e))throw r.errors&&r.errors.length>0?new Error(r.errors[0].message):new Error("Configuration validation failed.")}function E(){let e=new B;return e.setStrategy("build",new M),e.setStrategy("origin",new q),e.setStrategy("cache",new C),e.setStrategy("domain",new v),e.setStrategy("purge",new j),e.setStrategy("rules",new x),e}function F(e){let s=T(e);_(s);let r={};return E().transformToManifest(s,r),r}function R(e){let s={};try{s=JSON.parse(e)}catch{throw new Error("Invalid JSON configuration.")}let r={};return E().transformToConfig(s,r),r}function we(e){try{_(e)}catch(s){let r=new Error(s.message);throw r.stack=void 0,r}return e}export{R as convertJsonConfigToObject,we as defineConfig,F as processConfig};
