function A(o){return o.replace(/^\//,"")}var m=async(o,t=1e3)=>{let r=0,n=12e4,e=Date.now();for(;Date.now()-e<n;)try{return await o()}catch{if(r===0&&console.warn("Attempting to synchronize. The content may not be synchronized on the edge yet."),Date.now()-e>=n)throw new Error("Max retry time reached");console.log(`Retry attempt ${r+1} failed. Retrying in ${t*Math.pow(2,r)} ms...`),await new Promise(i=>setTimeout(i,t*Math.pow(2,r))),r++}throw new Error("Max retry time reached")},h=async(o,t,r)=>{let e=await B(o,{page_size:1e6},r?.debug??!1),s=e.results;return e.error?{error:e.error}:s?{data:s.find(b=>b.name===t)}:{error:{message:"Failed to retrieve buckets.",operation:"getBuckets"}}};async function g(o,t,r,n=!0){let e=await fetch(o,t);if(!e.ok){let s=`HTTP error! Status: ${e.status} - ${e.statusText}`;throw r&&console.log(`Error in fetch: ${s}`),new Error(s)}if(n){let s=e.headers.get("content-type");if(!s||!s.includes("application/json")){let S=`Expected JSON response, but got: ${await e.text()}`;throw r&&console.log(`Error in fetch: ${S}`),new Error(S)}return await e.json()}else return await e.text()}var u=process.env.AZION_ENV==="stage"?"https://stage-api.azion.com/v4/storage/buckets":"https://api.azion.com/v4/storage/buckets",l=(o,t,r)=>{let n={message:"Error unknown",operation:r};return o.forEach(e=>{t[e]&&(n={message:Array.isArray(t[e])?t[e].join(", "):t[e],operation:r})}),n},B=async(o,t,r)=>{try{let{page_size:n=10,page:e=1}=t||{},s=new URLSearchParams({page_size:String(n),page:String(e)}),i=await g(`${u}?${s.toString()}`,{method:"GET",headers:{Accept:"application/json; version=3",Authorization:`Token ${o}`}},r);return i.results?(r&&console.log("Response:",i),i):(i.error=l(["detail"],i,"get all buckets"),{error:i.error??JSON.stringify(i)})}catch(n){return r&&console.error("Error getting all buckets:",n),{error:{message:n.toString(),operation:"get all buckets"}}}},R=async(o,t,r,n)=>{try{let e=await g(u,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${o}`},body:JSON.stringify({name:t,edge_access:r})},n);return e?.state?(n&&console.log("Response:",e),e):(e.error=l(["name","edge_access","detail"],e,"create bucket"),{error:e.error??JSON.stringify(e)})}catch(e){return n&&console.error("Error creating bucket:",e),{error:{message:e.toString(),operation:"create bucket"}}}},P=async(o,t,r,n)=>{try{let e=await g(`${u}/${t}`,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${o}`},body:JSON.stringify({edge_access:r})},n);return e?.state?(n&&console.log("Response:",e),e):(e.error=l(["name","edge_access","detail"],e,"update bucket"),{error:e.error??JSON.stringify(e)})}catch(e){return n&&console.error("Error updating bucket:",e),{error:{message:e.toString(),operation:"update bucket"}}}},f=async(o,t,r)=>{try{let n=await g(`${u}/${t}`,{method:"DELETE",headers:{Accept:"application/json",Authorization:`Token ${o}`}},r);return n?.state?(r&&console.log("Response Delete Bucket:",n),n):(n.error=l(["detail"],n,"delete bucket"),{error:n.error??JSON.stringify(n)})}catch(n){return r&&console.error("Error deleting bucket:",n),{error:{message:n.toString(),operation:"delete bucket"}}}},C=async(o,t,r,n)=>{try{let{max_object_count:e=1e4}=r||{},s=new URLSearchParams({max_object_count:String(e)}),i=await g(`${u}/${t}/objects?${s.toString()}`,{method:"GET",headers:{Accept:"application/json",Authorization:`Token ${o}`}},n);return i.results?(n&&console.log("Response:",i),i):(i.error=l(["detail"],i,"get all objects"),{error:i.error??JSON.stringify(i)})}catch(e){return n&&console.error("Error getting all objects:",e),{error:{message:e.toString(),operation:"get all objects"}}}},w=async(o,t,r,n,e)=>{try{let s=await g(`${u}/${t}/objects/${r}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/octet-stream",Authorization:`Token ${o}`},body:n},e);return s?.state?(e&&console.log("Response:",s),s):(s.error=l(["detail"],s,"create object"),{error:s.error??JSON.stringify(s)})}catch(s){return e&&console.error("Error posting object:",s),{error:{message:s.toString(),operation:"create object"}}}},E=async(o,t,r,n)=>{try{let e=await fetch(`${u}/${t}/objects/${r}`,{method:"GET",headers:{Accept:"application/json",Authorization:`Token ${o}`}});if(e.headers.get("content-type")==="application/json"){let i=await e.json();return{error:l(["detail"],i,"get object by key")??JSON.stringify(i)}}let s=await e.text();return n&&console.log("Response:",s),{data:s}}catch(e){return n&&console.error("Error getting object by name:",e),{error:{message:e.toString(),operation:"get object by key"}}}},T=async(o,t,r,n,e)=>{try{let s=await g(`${u}/${t}/objects/${r}`,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/octet-stream",Authorization:`Token ${o}`},body:n},e);return e&&console.log("Response:",s),s}catch(s){return e&&console.error("Error putting object:",s),{error:{message:s.toString(),operation:"put object"}}}},_=async(o,t,r,n)=>{try{let e=await g(`${u}/${t}/objects/${r}`,{method:"DELETE",headers:{Accept:"application/json",Authorization:`Token ${o}`}},n);return e?.state?(n&&console.log("Response:",e),e):(e.error=l(["detail"],e,"delete object"),{error:e.error??JSON.stringify(e)})}catch(e){return n&&console.error("Error deleting object:",e),{error:{message:e.toString(),operation:"delete object"}}}};var x=()=>globalThis.Azion?.Sql||null,p=class{constructor(t,r){this.token=t;this.debug=r}storage=null;initializeStorage(t){this.storage||(this.storage=new globalThis.Azion.Storage(t))}name="";edge_access="unknown";async getBucket({name:t}){return this.initializeStorage(t),this.storage?(this.name=t,{name:t,edge_access:"unknown",state:"executed-runtime",getObjects:this.getObjects.bind(this),getObjectByKey:this.getObjectByKey.bind(this),createObject:this.createObject.bind(this),updateObject:this.updateObject.bind(this),deleteObject:this.deleteObject.bind(this)}):null}async getObjects({params:t}){this.initializeStorage(this.name);try{let r=await m(()=>this.storage.list()),n=t?.max_object_count??r.entries.length,e=await Promise.all(r.entries.slice(0,n).map(async s=>({key:A(s.key),size:s.content_length,state:"executed-runtime"})));return{data:{objects:e,count:e.length}}}catch(r){return this.debug&&console.error("Error getting objects:",r),{error:{message:r?.message??"Error getting objects",operation:"getObjects"}}}}async getObjectByKey({key:t}){this.initializeStorage(this.name);try{let r=await m(()=>this.storage.get(t)),n=await r.arrayBuffer(),s=new TextDecoder().decode(n);return{data:{state:"executed-runtime",key:A(t),size:r.contentLength,content:s,content_type:r.metadata.get("content-type")}}}catch(r){return this.debug&&console.error("Error getting object by key:",r),{error:{message:r?.message??"Error getting object by key",operation:"getObjectByKey"}}}}async createObject({key:t,content:r,options:n}){this.initializeStorage(this.name);try{let e=new TextEncoder().encode(r);return await m(()=>this.storage.put(t,e,{"content-type":n?.content_type})),{data:{state:"executed-runtime",key:A(t),size:e.byteLength,content_type:n?.content_type,content:r}}}catch(e){return this.debug&&console.error("Error creating object:",e),{error:{message:e?.message??"Error creating object",operation:"createObject"}}}}async updateObject({key:t,content:r,options:n}){return this.createObject({key:t,content:r,options:n})}async deleteObject({key:t}){this.initializeStorage(this.name);try{return await m(()=>this.storage.delete(t)),{data:{key:A(t),state:"executed-runtime"}}}catch(r){return this.debug&&console.error("Error deleting object:",r),{error:{message:r?.message??"Error deleting object",operation:"deleteObject"}}}}};var M=process.env.AZION_DEBUG&&process.env.AZION_DEBUG==="true",a=o=>o??process.env.AZION_TOKEN??"",c=o=>o??!!M,d=(o,t)=>(...r)=>x()?o(...r):t(...r),$=async(o,t,r,n)=>{let e=await R(a(o),t,r,c(n?.debug));return e.data?{data:{...e.data,getObjects:({params:s})=>z(o,t,s),getObjectByKey:({key:s})=>j(o,t,s),createObject:({key:s,content:i})=>O(o,t,s,i),updateObject:({key:s,content:i})=>y(o,t,s,i),deleteObject:({key:s})=>k(o,t,s)}}:{error:e.error}},D=async(o,t,r)=>{let n=await f(a(o),t,c(r?.debug));return n.data?{data:{name:n.data.name,state:n.state}}:{error:n.error}},v=async(o,t,r)=>{let n=await B(a(o),t,c(r?.debug));if(n?.results&&n.results.length>0){let e=n.results?.map(s=>({...s,getObjects:({params:i})=>z(o,s.name,i),getObjectByKey:({key:i})=>j(o,s.name,i),createObject:({key:i,content:b})=>O(o,s.name,i,b),updateObject:({key:i,content:b})=>y(o,s.name,i,b),deleteObject:({key:i})=>k(o,s.name,i)}));return{data:{buckets:e,count:n.count??e.length}}}return{error:n.error}},N=d(async(o,t,r)=>{let n=await h(o,t,r);if(n.error||!n.data?.name)return{error:{message:n.error?.message??"Bucket not found",operation:"get bucket"}};let s=await new p(o,r?.debug).getBucket({name:t});return s?{data:s}:{error:{message:"Failed to retrieve bucket",operation:"get bucket"}}},async(o,t,r)=>{let n=await h(o,t,r);return n.error||!n.data?.name?{error:{message:n.error?.message??"Bucket not found",operation:"get bucket"}}:{data:{name:n.data.name,edge_access:n.data?.edge_access,getObjects:({params:e})=>z(o,t,e),getObjectByKey:({key:e})=>j(o,t,e),createObject:({key:e,content:s})=>O(o,t,e,s),updateObject:({key:e,content:s})=>y(o,t,e,s),deleteObject:({key:e})=>k(o,t,e)}}}),L=async(o,t,r,n)=>{let e=await P(a(o),t,r,c(n?.debug));return e?.data?{data:{...e.data,getObjects:({params:s})=>z(o,t,s),getObjectByKey:({key:s})=>j(o,t,s),createObject:({key:s,content:i})=>O(o,t,s,i),updateObject:({key:s,content:i})=>y(o,t,s,i),deleteObject:({key:s})=>k(o,t,s)}}:{error:e.error}},z=d(async(o,t,r,n)=>{let e=new p(o,n?.debug);e.name=t;let s=await e.getObjects({params:r});return s.data?{data:s.data}:{error:{message:"Failed to retrieve objects",operation:"get objects"}}},async(o,t,r,n)=>{let e=await C(a(o),t,r,n?.debug);return e.results?{data:{objects:e.results,count:e.results.length}}:{error:e?.error}}),j=d(async(o,t,r,n)=>{let e=new p(o,n?.debug);e.name=t;let s=await e.getObjectByKey({key:r});return s.data?{data:s.data}:{error:{message:"Failed to retrieve object",operation:"get object by key"}}},async(o,t,r,n)=>{let e=await E(a(o),t,r,c(n?.debug));return e.data?{data:{key:r,content:e.data}}:{error:e.error}}),O=d(async(o,t,r,n,e)=>{let s=new p(o,e?.debug);s.name=t;let i=await s.createObject({key:r,content:n});return i?.data?{data:i.data}:{error:{message:"Failed to create object",operation:"create object"}}},async(o,t,r,n,e)=>{let s=await w(a(o),t,r,n,c(e?.debug));return s.data?{data:{key:s.data.object_key,content:n,state:s.state}}:{error:s.error}}),y=d(async(o,t,r,n,e)=>{let s=new p(o,e?.debug);s.name=t;let i=await s.updateObject({key:r,content:n});return i?.data?{data:i.data}:{error:i.error}},async(o,t,r,n,e)=>{let s=await T(a(o),t,r,n,c(e?.debug));return s.data?{data:{key:s.data.object_key,content:n,state:s.state}}:{error:s.error}}),k=d(async(o,t,r,n)=>{let e=new p(o,n?.debug);e.name=t;let s=await e.deleteObject({key:r});return s.data?{data:s.data}:{error:s.error}},async(o,t,r,n)=>{let e=await _(a(o),t,r,c(n?.debug));return e.data?{data:{key:r,state:e.state}}:{error:e.error}}),V=({name:o,edge_access:t,options:r})=>$(a(),o,t,{...r,debug:c(r?.debug)}),Q=({name:o,options:t})=>D(a(),o,{...t,debug:c(t?.debug)}),X=({params:o,options:t})=>v(a(),o,{...t,debug:c(t?.debug)}),Y=({name:o,options:t})=>N(a(),o,{...t,debug:c(t?.debug)}),ee=({name:o,edge_access:t,options:r})=>L(a(),o,t,{...r,debug:c(r?.debug)}),te=({bucket:o,params:t,options:r})=>z(a(),o,t,r),re=({bucket:o,key:t,content:r,options:n})=>O(a(),o,t,r,{...n,debug:c(n?.debug)}),oe=({bucket:o,key:t,options:r})=>j(a(),o,t,{...r,debug:c(r?.debug)}),ne=({bucket:o,key:t,content:r,options:n})=>y(a(),o,t,r,{...n,debug:c(n?.debug)}),se=({bucket:o,key:t,options:r})=>k(a(),o,t,{...r,debug:c(r?.debug)}),K=o=>{let t=a(o?.token),r=c(o?.options?.debug);return{getBuckets:e=>v(t,e?.params,{...o,debug:r}),createBucket:({name:e,edge_access:s})=>$(t,e,s,{...o,debug:r}),updateBucket:({name:e,edge_access:s})=>L(t,e,s,{...o,debug:r}),deleteBucket:({name:e})=>D(t,e,{...o,debug:r}),getBucket:({name:e})=>N(t,e,{...o,debug:r})}};var ie=K;export{V as createBucket,$ as createBucketMethod,K as createClient,re as createObject,ie as default,Q as deleteBucket,D as deleteBucketMethod,se as deleteObject,Y as getBucket,X as getBuckets,v as getBucketsMethod,oe as getObjectByKey,te as getObjects,ee as updateBucket,L as updateBucketMethod,ne as updateObject};
