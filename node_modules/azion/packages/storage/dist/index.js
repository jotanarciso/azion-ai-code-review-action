"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; } var _class;function A(o){return o.replace(/^\//,"")}var m=async(o,t=1e3)=>{let r=0,n=12e4,e=Date.now();for(;Date.now()-e<n;)try{return await o()}catch (e2){if(r===0&&console.warn("Attempting to synchronize. The content may not be synchronized on the edge yet."),Date.now()-e>=n)throw new Error("Max retry time reached");console.log(`Retry attempt ${r+1} failed. Retrying in ${t*Math.pow(2,r)} ms...`),await new Promise(i=>setTimeout(i,t*Math.pow(2,r))),r++}throw new Error("Max retry time reached")},h=async(o,t,r)=>{let e=await B(o,{page_size:1e6},_nullishCoalesce(_optionalChain([r, 'optionalAccess', _2 => _2.debug]), () => (!1))),s=e.results;return e.error?{error:e.error}:s?{data:s.find(b=>b.name===t)}:{error:{message:"Failed to retrieve buckets.",operation:"getBuckets"}}};async function g(o,t,r,n=!0){let e=await fetch(o,t);if(!e.ok){let s=`HTTP error! Status: ${e.status} - ${e.statusText}`;throw r&&console.log(`Error in fetch: ${s}`),new Error(s)}if(n){let s=e.headers.get("content-type");if(!s||!s.includes("application/json")){let S=`Expected JSON response, but got: ${await e.text()}`;throw r&&console.log(`Error in fetch: ${S}`),new Error(S)}return await e.json()}else return await e.text()}var u=process.env.AZION_ENV==="stage"?"https://stage-api.azion.com/v4/storage/buckets":"https://api.azion.com/v4/storage/buckets",l=(o,t,r)=>{let n={message:"Error unknown",operation:r};return o.forEach(e=>{t[e]&&(n={message:Array.isArray(t[e])?t[e].join(", "):t[e],operation:r})}),n},B=async(o,t,r)=>{try{let{page_size:n=10,page:e=1}=t||{},s=new URLSearchParams({page_size:String(n),page:String(e)}),i=await g(`${u}?${s.toString()}`,{method:"GET",headers:{Accept:"application/json; version=3",Authorization:`Token ${o}`}},r);return i.results?(r&&console.log("Response:",i),i):(i.error=l(["detail"],i,"get all buckets"),{error:_nullishCoalesce(i.error, () => (JSON.stringify(i)))})}catch(n){return r&&console.error("Error getting all buckets:",n),{error:{message:n.toString(),operation:"get all buckets"}}}},R=async(o,t,r,n)=>{try{let e=await g(u,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${o}`},body:JSON.stringify({name:t,edge_access:r})},n);return _optionalChain([e, 'optionalAccess', _3 => _3.state])?(n&&console.log("Response:",e),e):(e.error=l(["name","edge_access","detail"],e,"create bucket"),{error:_nullishCoalesce(e.error, () => (JSON.stringify(e)))})}catch(e){return n&&console.error("Error creating bucket:",e),{error:{message:e.toString(),operation:"create bucket"}}}},P=async(o,t,r,n)=>{try{let e=await g(`${u}/${t}`,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Token ${o}`},body:JSON.stringify({edge_access:r})},n);return _optionalChain([e, 'optionalAccess', _4 => _4.state])?(n&&console.log("Response:",e),e):(e.error=l(["name","edge_access","detail"],e,"update bucket"),{error:_nullishCoalesce(e.error, () => (JSON.stringify(e)))})}catch(e){return n&&console.error("Error updating bucket:",e),{error:{message:e.toString(),operation:"update bucket"}}}},f=async(o,t,r)=>{try{let n=await g(`${u}/${t}`,{method:"DELETE",headers:{Accept:"application/json",Authorization:`Token ${o}`}},r);return _optionalChain([n, 'optionalAccess', _5 => _5.state])?(r&&console.log("Response Delete Bucket:",n),n):(n.error=l(["detail"],n,"delete bucket"),{error:_nullishCoalesce(n.error, () => (JSON.stringify(n)))})}catch(n){return r&&console.error("Error deleting bucket:",n),{error:{message:n.toString(),operation:"delete bucket"}}}},C=async(o,t,r,n)=>{try{let{max_object_count:e=1e4}=r||{},s=new URLSearchParams({max_object_count:String(e)}),i=await g(`${u}/${t}/objects?${s.toString()}`,{method:"GET",headers:{Accept:"application/json",Authorization:`Token ${o}`}},n);return i.results?(n&&console.log("Response:",i),i):(i.error=l(["detail"],i,"get all objects"),{error:_nullishCoalesce(i.error, () => (JSON.stringify(i)))})}catch(e){return n&&console.error("Error getting all objects:",e),{error:{message:e.toString(),operation:"get all objects"}}}},w=async(o,t,r,n,e)=>{try{let s=await g(`${u}/${t}/objects/${r}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/octet-stream",Authorization:`Token ${o}`},body:n},e);return _optionalChain([s, 'optionalAccess', _6 => _6.state])?(e&&console.log("Response:",s),s):(s.error=l(["detail"],s,"create object"),{error:_nullishCoalesce(s.error, () => (JSON.stringify(s)))})}catch(s){return e&&console.error("Error posting object:",s),{error:{message:s.toString(),operation:"create object"}}}},E=async(o,t,r,n)=>{try{let e=await fetch(`${u}/${t}/objects/${r}`,{method:"GET",headers:{Accept:"application/json",Authorization:`Token ${o}`}});if(e.headers.get("content-type")==="application/json"){let i=await e.json();return{error:_nullishCoalesce(l(["detail"],i,"get object by key"), () => (JSON.stringify(i)))}}let s=await e.text();return n&&console.log("Response:",s),{data:s}}catch(e){return n&&console.error("Error getting object by name:",e),{error:{message:e.toString(),operation:"get object by key"}}}},T=async(o,t,r,n,e)=>{try{let s=await g(`${u}/${t}/objects/${r}`,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/octet-stream",Authorization:`Token ${o}`},body:n},e);return e&&console.log("Response:",s),s}catch(s){return e&&console.error("Error putting object:",s),{error:{message:s.toString(),operation:"put object"}}}},_=async(o,t,r,n)=>{try{let e=await g(`${u}/${t}/objects/${r}`,{method:"DELETE",headers:{Accept:"application/json",Authorization:`Token ${o}`}},n);return _optionalChain([e, 'optionalAccess', _7 => _7.state])?(n&&console.log("Response:",e),e):(e.error=l(["detail"],e,"delete object"),{error:_nullishCoalesce(e.error, () => (JSON.stringify(e)))})}catch(e){return n&&console.error("Error deleting object:",e),{error:{message:e.toString(),operation:"delete object"}}}};var x=()=>_optionalChain([globalThis, 'access', _8 => _8.Azion, 'optionalAccess', _9 => _9.Sql])||null,p= (_class =class{constructor(t,r){;_class.prototype.__init.call(this);_class.prototype.__init2.call(this);_class.prototype.__init3.call(this);this.token=t;this.debug=r}__init() {this.storage=null}initializeStorage(t){this.storage||(this.storage=new globalThis.Azion.Storage(t))}__init2() {this.name=""}__init3() {this.edge_access="unknown"}async getBucket({name:t}){return this.initializeStorage(t),this.storage?(this.name=t,{name:t,edge_access:"unknown",state:"executed-runtime",getObjects:this.getObjects.bind(this),getObjectByKey:this.getObjectByKey.bind(this),createObject:this.createObject.bind(this),updateObject:this.updateObject.bind(this),deleteObject:this.deleteObject.bind(this)}):null}async getObjects({params:t}){this.initializeStorage(this.name);try{let r=await m(()=>this.storage.list()),n=_nullishCoalesce(_optionalChain([t, 'optionalAccess', _10 => _10.max_object_count]), () => (r.entries.length)),e=await Promise.all(r.entries.slice(0,n).map(async s=>({key:A(s.key),size:s.content_length,state:"executed-runtime"})));return{data:{objects:e,count:e.length}}}catch(r){return this.debug&&console.error("Error getting objects:",r),{error:{message:_nullishCoalesce(_optionalChain([r, 'optionalAccess', _11 => _11.message]), () => ("Error getting objects")),operation:"getObjects"}}}}async getObjectByKey({key:t}){this.initializeStorage(this.name);try{let r=await m(()=>this.storage.get(t)),n=await r.arrayBuffer(),s=new TextDecoder().decode(n);return{data:{state:"executed-runtime",key:A(t),size:r.contentLength,content:s,content_type:r.metadata.get("content-type")}}}catch(r){return this.debug&&console.error("Error getting object by key:",r),{error:{message:_nullishCoalesce(_optionalChain([r, 'optionalAccess', _12 => _12.message]), () => ("Error getting object by key")),operation:"getObjectByKey"}}}}async createObject({key:t,content:r,options:n}){this.initializeStorage(this.name);try{let e=new TextEncoder().encode(r);return await m(()=>this.storage.put(t,e,{"content-type":_optionalChain([n, 'optionalAccess', _13 => _13.content_type])})),{data:{state:"executed-runtime",key:A(t),size:e.byteLength,content_type:_optionalChain([n, 'optionalAccess', _14 => _14.content_type]),content:r}}}catch(e){return this.debug&&console.error("Error creating object:",e),{error:{message:_nullishCoalesce(_optionalChain([e, 'optionalAccess', _15 => _15.message]), () => ("Error creating object")),operation:"createObject"}}}}async updateObject({key:t,content:r,options:n}){return this.createObject({key:t,content:r,options:n})}async deleteObject({key:t}){this.initializeStorage(this.name);try{return await m(()=>this.storage.delete(t)),{data:{key:A(t),state:"executed-runtime"}}}catch(r){return this.debug&&console.error("Error deleting object:",r),{error:{message:_nullishCoalesce(_optionalChain([r, 'optionalAccess', _16 => _16.message]), () => ("Error deleting object")),operation:"deleteObject"}}}}}, _class);var M=process.env.AZION_DEBUG&&process.env.AZION_DEBUG==="true",a=o=>_nullishCoalesce(_nullishCoalesce(o, () => (process.env.AZION_TOKEN)), () => ("")),c=o=>_nullishCoalesce(o, () => (!!M)),d=(o,t)=>(...r)=>x()?o(...r):t(...r),$= exports.createBucketMethod =async(o,t,r,n)=>{let e=await R(a(o),t,r,c(_optionalChain([n, 'optionalAccess', _17 => _17.debug])));return e.data?{data:{...e.data,getObjects:({params:s})=>z(o,t,s),getObjectByKey:({key:s})=>j(o,t,s),createObject:({key:s,content:i})=>O(o,t,s,i),updateObject:({key:s,content:i})=>y(o,t,s,i),deleteObject:({key:s})=>k(o,t,s)}}:{error:e.error}},D= exports.deleteBucketMethod =async(o,t,r)=>{let n=await f(a(o),t,c(_optionalChain([r, 'optionalAccess', _18 => _18.debug])));return n.data?{data:{name:n.data.name,state:n.state}}:{error:n.error}},v= exports.getBucketsMethod =async(o,t,r)=>{let n=await B(a(o),t,c(_optionalChain([r, 'optionalAccess', _19 => _19.debug])));if(_optionalChain([n, 'optionalAccess', _20 => _20.results])&&n.results.length>0){let e=_optionalChain([n, 'access', _21 => _21.results, 'optionalAccess', _22 => _22.map, 'call', _23 => _23(s=>({...s,getObjects:({params:i})=>z(o,s.name,i),getObjectByKey:({key:i})=>j(o,s.name,i),createObject:({key:i,content:b})=>O(o,s.name,i,b),updateObject:({key:i,content:b})=>y(o,s.name,i,b),deleteObject:({key:i})=>k(o,s.name,i)}))]);return{data:{buckets:e,count:_nullishCoalesce(n.count, () => (e.length))}}}return{error:n.error}},N=d(async(o,t,r)=>{let n=await h(o,t,r);if(n.error||!_optionalChain([n, 'access', _24 => _24.data, 'optionalAccess', _25 => _25.name]))return{error:{message:_nullishCoalesce(_optionalChain([n, 'access', _26 => _26.error, 'optionalAccess', _27 => _27.message]), () => ("Bucket not found")),operation:"get bucket"}};let s=await new p(o,_optionalChain([r, 'optionalAccess', _28 => _28.debug])).getBucket({name:t});return s?{data:s}:{error:{message:"Failed to retrieve bucket",operation:"get bucket"}}},async(o,t,r)=>{let n=await h(o,t,r);return n.error||!_optionalChain([n, 'access', _29 => _29.data, 'optionalAccess', _30 => _30.name])?{error:{message:_nullishCoalesce(_optionalChain([n, 'access', _31 => _31.error, 'optionalAccess', _32 => _32.message]), () => ("Bucket not found")),operation:"get bucket"}}:{data:{name:n.data.name,edge_access:_optionalChain([n, 'access', _33 => _33.data, 'optionalAccess', _34 => _34.edge_access]),getObjects:({params:e})=>z(o,t,e),getObjectByKey:({key:e})=>j(o,t,e),createObject:({key:e,content:s})=>O(o,t,e,s),updateObject:({key:e,content:s})=>y(o,t,e,s),deleteObject:({key:e})=>k(o,t,e)}}}),L= exports.updateBucketMethod =async(o,t,r,n)=>{let e=await P(a(o),t,r,c(_optionalChain([n, 'optionalAccess', _35 => _35.debug])));return _optionalChain([e, 'optionalAccess', _36 => _36.data])?{data:{...e.data,getObjects:({params:s})=>z(o,t,s),getObjectByKey:({key:s})=>j(o,t,s),createObject:({key:s,content:i})=>O(o,t,s,i),updateObject:({key:s,content:i})=>y(o,t,s,i),deleteObject:({key:s})=>k(o,t,s)}}:{error:e.error}},z=d(async(o,t,r,n)=>{let e=new p(o,_optionalChain([n, 'optionalAccess', _37 => _37.debug]));e.name=t;let s=await e.getObjects({params:r});return s.data?{data:s.data}:{error:{message:"Failed to retrieve objects",operation:"get objects"}}},async(o,t,r,n)=>{let e=await C(a(o),t,r,_optionalChain([n, 'optionalAccess', _38 => _38.debug]));return e.results?{data:{objects:e.results,count:e.results.length}}:{error:_optionalChain([e, 'optionalAccess', _39 => _39.error])}}),j=d(async(o,t,r,n)=>{let e=new p(o,_optionalChain([n, 'optionalAccess', _40 => _40.debug]));e.name=t;let s=await e.getObjectByKey({key:r});return s.data?{data:s.data}:{error:{message:"Failed to retrieve object",operation:"get object by key"}}},async(o,t,r,n)=>{let e=await E(a(o),t,r,c(_optionalChain([n, 'optionalAccess', _41 => _41.debug])));return e.data?{data:{key:r,content:e.data}}:{error:e.error}}),O=d(async(o,t,r,n,e)=>{let s=new p(o,_optionalChain([e, 'optionalAccess', _42 => _42.debug]));s.name=t;let i=await s.createObject({key:r,content:n});return _optionalChain([i, 'optionalAccess', _43 => _43.data])?{data:i.data}:{error:{message:"Failed to create object",operation:"create object"}}},async(o,t,r,n,e)=>{let s=await w(a(o),t,r,n,c(_optionalChain([e, 'optionalAccess', _44 => _44.debug])));return s.data?{data:{key:s.data.object_key,content:n,state:s.state}}:{error:s.error}}),y=d(async(o,t,r,n,e)=>{let s=new p(o,_optionalChain([e, 'optionalAccess', _45 => _45.debug]));s.name=t;let i=await s.updateObject({key:r,content:n});return _optionalChain([i, 'optionalAccess', _46 => _46.data])?{data:i.data}:{error:i.error}},async(o,t,r,n,e)=>{let s=await T(a(o),t,r,n,c(_optionalChain([e, 'optionalAccess', _47 => _47.debug])));return s.data?{data:{key:s.data.object_key,content:n,state:s.state}}:{error:s.error}}),k=d(async(o,t,r,n)=>{let e=new p(o,_optionalChain([n, 'optionalAccess', _48 => _48.debug]));e.name=t;let s=await e.deleteObject({key:r});return s.data?{data:s.data}:{error:s.error}},async(o,t,r,n)=>{let e=await _(a(o),t,r,c(_optionalChain([n, 'optionalAccess', _49 => _49.debug])));return e.data?{data:{key:r,state:e.state}}:{error:e.error}}),V= exports.createBucket =({name:o,edge_access:t,options:r})=>$(a(),o,t,{...r,debug:c(_optionalChain([r, 'optionalAccess', _50 => _50.debug]))}),Q= exports.deleteBucket =({name:o,options:t})=>D(a(),o,{...t,debug:c(_optionalChain([t, 'optionalAccess', _51 => _51.debug]))}),X= exports.getBuckets =({params:o,options:t})=>v(a(),o,{...t,debug:c(_optionalChain([t, 'optionalAccess', _52 => _52.debug]))}),Y= exports.getBucket =({name:o,options:t})=>N(a(),o,{...t,debug:c(_optionalChain([t, 'optionalAccess', _53 => _53.debug]))}),ee= exports.updateBucket =({name:o,edge_access:t,options:r})=>L(a(),o,t,{...r,debug:c(_optionalChain([r, 'optionalAccess', _54 => _54.debug]))}),te= exports.getObjects =({bucket:o,params:t,options:r})=>z(a(),o,t,r),re= exports.createObject =({bucket:o,key:t,content:r,options:n})=>O(a(),o,t,r,{...n,debug:c(_optionalChain([n, 'optionalAccess', _55 => _55.debug]))}),oe= exports.getObjectByKey =({bucket:o,key:t,options:r})=>j(a(),o,t,{...r,debug:c(_optionalChain([r, 'optionalAccess', _56 => _56.debug]))}),ne= exports.updateObject =({bucket:o,key:t,content:r,options:n})=>y(a(),o,t,r,{...n,debug:c(_optionalChain([n, 'optionalAccess', _57 => _57.debug]))}),se= exports.deleteObject =({bucket:o,key:t,options:r})=>k(a(),o,t,{...r,debug:c(_optionalChain([r, 'optionalAccess', _58 => _58.debug]))}),K= exports.createClient =o=>{let t=a(_optionalChain([o, 'optionalAccess', _59 => _59.token])),r=c(_optionalChain([o, 'optionalAccess', _60 => _60.options, 'optionalAccess', _61 => _61.debug]));return{getBuckets:e=>v(t,_optionalChain([e, 'optionalAccess', _62 => _62.params]),{...o,debug:r}),createBucket:({name:e,edge_access:s})=>$(t,e,s,{...o,debug:r}),updateBucket:({name:e,edge_access:s})=>L(t,e,s,{...o,debug:r}),deleteBucket:({name:e})=>D(t,e,{...o,debug:r}),getBucket:({name:e})=>N(t,e,{...o,debug:r})}};var ie=K;exports.createBucket = V; exports.createBucketMethod = $; exports.createClient = K; exports.createObject = re; exports.default = ie; exports.deleteBucket = Q; exports.deleteBucketMethod = D; exports.deleteObject = se; exports.getBucket = Y; exports.getBuckets = X; exports.getBucketsMethod = v; exports.getObjectByKey = oe; exports.getObjects = te; exports.updateBucket = ee; exports.updateBucketMethod = L; exports.updateObject = ne;
